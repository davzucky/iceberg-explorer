## 2026-01-16 - US-001
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Verified all acceptance criteria for US-001 (Project Setup and Configuration) are met
- Confirmed pyproject.toml has FastAPI, DuckDB, Granian dependencies configured
- Verified source code structure in src/iceberg_explorer/
- Confirmed pre-commit hooks configured (ruff, pyupgrade)
- Verified project uses uv for dependency management
- All 324 tests pass with uv run pytest
- Ruff linting passes with uv run ruff check src/
- Code has type hints and Pydantic validation

**Learnings for future iterations:**
- This project uses uv for dependency management (not npm/pnpm)
- Quality checks: `uv run ruff check src/ tests/` and `uv run pytest`
- Typechecking is handled via Pydantic models and type hints (no mypy/pyright configured)
- Pre-commit hooks are in .pre-commit-config.yaml
- Source code is organized in src/iceberg_explorer/ with api/, models/, query/ subdirectories
- Tests are in tests/ directory matching source structure with test_ prefix

---
## 2026-01-16 - US-002
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Verified all acceptance criteria for US-002 (Configuration System) are met
- Config loads from JSON file via ICEBERG_EXPLORER_CONFIG env var
- Env var overrides supported with ICEBERG_EXPLORER_ prefix (double underscore for nested)
- Pydantic models created: CatalogConfig, QueryConfig, DuckDBConfig, ServerConfig, ExportConfig, OTelConfig, Settings
- Both REST and local catalog types supported via CatalogType enum
- DuckDB memory limit and threads limits configurable in DuckDBConfig
- All optional settings have sensible defaults
- 21 config tests cover loading and validation
- All 324 tests pass
- Code has type hints

**Learnings for future iterations:**
- Config system uses pydantic-settings with nested settings
- Env vars use ICEBERG_EXPLORER_ prefix with double underscore for nested values (e.g., ICEBERG_EXPLORER_QUERY__MAX_ROWS)
- Settings are cached globally via _settings variable
- Use reset_settings() in tests to clear cache
- JSON config file values are overridden by env vars

---
## 2026-01-16 - US-003
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Verified all acceptance criteria for US-003 (DuckDB Engine Initialization) are met
- DuckDBEngine class manages connection pool
- Iceberg catalog attached on initialization (REST or local)
- Read-only mode enforced (via validate_sql in executor)
- Memory limit and thread count configurable from settings
- Health check method verifies DuckDB and catalog connectivity
- 18 engine tests with local Iceberg catalog fixtures
- All 324 tests pass
- Ruff checks pass
- Code has type hints

**Learnings for future iterations:**
- DuckDB engine uses threading.Lock for thread-safe connection handling
- Engine is cached globally via _engine variable
- Use reset_engine() in tests to clear cache
- Health check returns dict with healthy, duckdb, catalog, error fields
- get_connection() is a contextmanager that yields cursor
- Write access required at connection level for INSTALL/LOAD/ATTACH, but user SQL is SELECT-only
- SQL injection protection via quoting in ATTACH statements

---
## 2026-01-16 - US-004
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Verified all acceptance criteria for US-004 (Query Execution Engine) are met
- Execute SQL query with configurable timeout (10s - 3600s)
- Return results as Arrow batches for streaming
- Reject non-SELECT statements (INSERT, UPDATE, DELETE, DROP) via validate_sql()
- Track execution metrics (duration, rows scanned) in QueryResult.metrics
- Implement query cancellation via DuckDB interrupt()
- 47 executor tests including integration tests
- All 324 tests pass
- Code has type hints

**Learnings for future iterations:**
- validate_sql() uses regex patterns to detect forbidden keywords
- FORBIDDEN_PATTERN checks at line start; FORBIDDEN_ANYWHERE_PATTERN catches CTE bypasses
- Allowed prefixes: WITH, SELECT, EXPLAIN, DESCRIBE, SHOW
- Query execution uses threading.Thread with daemon=True for timeout handling
- cancel() uses threading.Event to signal cancellation and active_conn.interrupt()
- Execution metrics: duration_seconds, rows_returned
- OpenTelemetry spans automatically created for queries with attributes: db.system, db.operation, query.id, query.timeout_seconds
- Executor is cached globally via _executor variable
- Use reset_executor() in tests to clear cache

---
## 2026-01-16 - US-005
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Verified all acceptance criteria for US-005 (List Namespaces Endpoint) are met
- GET /api/v1/catalog/namespaces returns top-level namespace list
- GET /api/v1/catalog/namespaces?parent={ns} returns child namespaces
- Parent parameter uses unit separator (%1F) for multi-level namespaces
- Namespaces returned as arrays of arrays (list[list[str]])
- Pagination supported with page-token and page-size params
- Returns 404 if parent namespace doesn't exist
- Empty list for catalogs with no namespaces
- Integration tests with nested namespace hierarchy
- All 324 tests pass
- Code has type hints

**Learnings for future iterations:**
- _parse_namespace() in utils handles unit separator (\x1f) decoding
- _build_namespace_path() constructs fully qualified SQL identifiers
- Filters out system namespaces: main, information_schema, pg_catalog
- Parent validation queries parent's information_schema.schemata
- Pagination tokens accepted but not yet implemented

---
## 2026-01-16 - US-006
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Verified all acceptance criteria for US-006 (List Tables Endpoint) are met
- GET /api/v1/catalog/namespaces/{namespace}/tables returns table list
- Namespace path uses unit separator for multi-level
- Return table identifiers as {namespace: [...], name: "table_name"}
- Returns 404 for non-existent namespace
- Integration tests with sample tables
- All 324 tests pass
- Code has type hints

**Learnings for future iterations:**
- list_tables() uses _parse_namespace() to decode namespace path
- Returns TableIdentifier objects with namespace and name fields
- Validates namespace exists via information_schema.schemata query
- Filters tables from information_schema.tables with table_schema filter

---
## 2026-01-16 - US-007
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Verified all acceptance criteria for US-007 (Table Details Endpoint) are met
- GET /api/v1/catalog/tables/{namespace}.{table} returns details
- Includes: location, format, partition spec, sort order, current snapshot
- Returns snapshot history (list of snapshots with timestamps)
- Returns 404 for non-existent table
- Integration tests verifying all metadata fields
- All 324 tests pass
- Code has type hints

**Learnings for future iterations:**
- get_table_details() uses _parse_table_path() to extract namespace and table name
- Fetches snapshots via iceberg_snapshots() function
- Handles timestamp conversion (datetime objects, strings, integers)
- current_snapshot is the one with max sequence_number
- Location extracted from manifest_path or falls back to S3 pattern
- Partition spec and sort order returned as None (not yet implemented)

---
## 2026-01-16 - US-008
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Verified all acceptance criteria for US-008 (Table Schema Endpoint) are met
- GET /api/v1/catalog/tables/{namespace}.{table}/schema returns schema
- Include column name, type, field ID, nullable flag
- Mark partition columns with indicator
- Include column statistics if available (currently None)
- Integration tests with various column types
- All 324 tests pass
- Code has type hints

**Learnings for future iterations:**
- get_table_schema() queries information_schema.columns
- Extracts partition columns from iceberg_metadata()
- Filters partition metadata from "partition_value" or "partition" columns
- SchemaField includes field_id, name, type, nullable, is_partition_column
- Column statistics returned but not yet populated
- is_nullable determined from information_schema.columns.is_nullable field

---
## 2026-01-16 - US-009
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Verified all acceptance criteria for US-009 (Execute Query Endpoint) are met
- POST /api/v1/query/execute accepts SQL and optional timeout
- Returns query_id for tracking
- Validates SQL is SELECT-only before execution
- Default timeout 300s, user can specify 10s-3600s
- Returns error with message for invalid queries
- Unit tests for SQL validation
- Integration tests for execution
- All 324 tests pass
- Code has type hints

**Learnings for future iterations:**
- execute_query() uses asyncio.to_thread() to run executor.execute in thread pool
- Returns ExecuteQueryResponse with query_id and status fields
- validate_sql() called before execution for security
- Timeout validation handled in executor._validate_timeout()

---
## 2026-01-16 - US-010
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Verified all acceptance criteria for US-010 (Query Results Endpoint) are met
- GET /api/v1/query/{query_id}/results streams JSON lines
- Stream format: metadata -> data batches -> progress -> complete
- Support page_size param (100, 250, 500, 1000)
- Support offset param for pagination
- Include execution metrics in complete message
- Integration tests verifying streaming behavior
- All 324 tests pass
- Code has type hints

**Learnings for future iterations:**
- StreamingResponse with application/x-ndjson content type
- _stream_results() is an async generator yielding JSON lines
- Waits up to 1 hour for query completion
- Arrow values converted to JSON-serializable via _convert_value()
- Batches sent in chunks of 100 rows
- Progress updates sent after each batch
- Cleanup called in finally block to prevent memory leaks
- page_size must be in VALID_PAGE_SIZES set

---
## 2026-01-16 - US-011
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Verified all acceptance criteria for US-011 (Query Status Endpoint) are met
- GET /api/v1/query/{query_id}/status returns current state
- States: pending, running, completed, failed, cancelled
- Include progress info for running queries (rows_processed)
- Include error message for failed queries
- Unit tests for state transitions
- All 324 tests pass
- Code has type hints

**Learnings for future iterations:**
- get_query_status() returns QueryStatusResponse with query_id, status, rows_processed, error_message
- rows_processed only set for completed queries (from metrics)
- Returns 404 if query not found
- Returns 400 if query_id is invalid UUID format

---
## 2026-01-16 - US-012
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Verified all acceptance criteria for US-012 (Cancel Query Endpoint) are met
- POST /api/v1/query/{query_id}/cancel stops execution
- DuckDB query interrupted cleanly via executor.cancel()
- Status updates to cancelled
- Returns success even if query already finished (cancelled flag)
- Integration tests verifying cancellation works
- All 324 tests pass
- Code has type hints

**Learnings for future iterations:**
- cancel_query() returns CancelQueryResponse with query_id, cancelled, status fields
- was_cancelled is True if cancellation succeeded, False if already terminal
- Calls executor.cancel() which uses threading.Event and conn.interrupt()
- Returns 404 if query not found
- Returns 400 if query_id is invalid UUID format

---
## 2026-01-16 - US-013
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Verified all acceptance criteria for US-013 (CSV Export Endpoint) are met
- POST /api/v1/export/csv accepts query_id or inline SQL
- Stream CSV as chunked download
- Configurable max size (default 1GB)
- Proper Content-Disposition header with filename
- Handle large exports without memory issues (8KB chunks)
- Integration tests with various data types
- All 324 tests pass
- Code has type hints

**Learnings for future iterations:**
- export_csv() validates that either query_id or sql is provided, not both
- _format_value() handles None, bool, datetime, bytes, Arrow types
- _stream_csv() is an async generator yielding byte chunks
- Waits up to 1 hour for query completion
- Sanitizes filename for cross-platform and HTTP header safety
- Buffer size is 8192 bytes before yielding
- Tracks bytes_written to enforce max_size_bytes limit
- Custom filename defaults to "export_{query_uuid}" if not provided

---
## 2026-01-16 - US-020
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Verified all acceptance criteria for US-020 (Health and Readiness Endpoints) are met
- GET /health returns status, version, component health
- GET /ready returns readiness for traffic
- Check DuckDB connectivity in health
- Check catalog connectivity in health
- Return 503 if unhealthy
- Unit tests for health logic
- All 324 tests pass
- Code has type hints

**Learnings for future iterations:**
- health_check() returns HealthResponse with status (healthy/degraded/unhealthy)
- Status is "healthy" if both components healthy, "degraded" if at least one healthy, "unhealthy" if none
- Sets response.status_code = 503 when not healthy or degraded
- readiness_check() returns ReadyResponse with ready flag
- Both endpoints use engine.health_check() which checks DuckDB and catalog
- ComponentHealth has healthy bool and optional error string

---
## 2026-01-16 - US-021
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Verified all acceptance criteria for US-021 (OpenTelemetry Instrumentation) are met
- OpenTelemetry SDK integrated with auto-instrumentation
- FastAPI routes automatically traced via FastAPIInstrumentor
- DuckDB query spans with duration and row count attributes
- Metrics: query_duration_seconds, query_rows_returned, active_queries
- Configurable OTLP exporter endpoint from settings
- Service name set to iceberg-explorer from settings
- Structured JSON logs with trace context (trace_id, span_id)
- No sensitive data in logs (SQL not logged)
- Integration tests verifying traces and metrics emitted
- All 324 tests pass
- Code has type hints

**Learnings for future iterations:**
- setup_opentelemetry() initializes tracer and meter providers with OTLP exporters
- PeriodicExportingMetricReader exports metrics every 10 seconds
- FastAPIInstrumentor.instrument_app() auto-instruments all routes
- _add_trace_context() adds trace_id and span_id to all log records
- Use increment/decrement_active_queries() to track active query count
- record_query_duration() and record_query_rows() record metrics with status labels
- setup_opentelemetry() is idempotent (returns if _initialized)
- Use reset_observability() in tests to clear state

---
## 2026-01-16 - US-014
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Verified all acceptance criteria for US-014 (Base Layout and Navigation) are met
- Base HTML template with header, sidebar, main content
- Tailwind CSS for styling (via CDN with custom iceberg colors)
- HTMX loaded for dynamic updates (from unpkg CDN)
- Alpine.js loaded for client-side interactivity (deferred load from unpkg)
- Responsive design (works on tablet+ - mobile sidebar toggle, hidden md:flex nav)
- All 324 tests pass
- Code has type hints

**Learnings for future iterations:**
- base.html extends Jinja2 blocks for title, nav_home, nav_query, sidebar, content, head, scripts
- Tailwind configured with custom iceberg colors in script block
- Health status checks /health endpoint every 30s via HTMX
- Sidebar uses Alpine x-data="{ sidebarOpen: true }" for mobile toggle
- HTMX indicators use htmx-indicator class with opacity transitions

---
## 2026-01-16 - US-015
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Verified all acceptance criteria for US-015 (Namespace Tree Browser) are met
- Sidebar shows namespace tree via /ui/partials/namespace-tree
- Click namespace to expand/collapse (lazy load via HTMX hx-get with click once trigger)
- Tables shown as leaf nodes under namespaces (in namespace_children.html)
- Click table to load details in main panel (hx-target="#main-content")
- Loading indicator during fetch (htmx-indicator spans with spinning SVG)
- All 324 tests pass
- Code has type hints

**Learnings for future iterations:**
- Namespace tree uses Alpine x-data="{ expanded: false }" for state
- Chevron rotates 90deg when expanded
- hx-get="/ui/partials/namespace-children?parent={{ ns.encoded_path }}" loads children
- hx-trigger="click once" ensures single load per expand
- Namespace items have stable ID via _generate_id() (MD5 hash)
- Tables show table icon, namespaces show folder icon
- Loading uses SVG spinner with animate-spin class

---
## 2026-01-16 - US-016
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Verified all acceptance criteria for US-016 (Table Details View) are met
- Main panel shows selected table metadata via /ui/partials/table-details
- Tabs for: Overview, Schema, Snapshots (Alpine x-data="{ activeTab: 'overview' }")
- Overview: location, format, partitioning, columns, snapshots, current snapshot
- Schema: searchable column list with type badges and nullable indicators
- Snapshots: list with timestamps (current snapshot highlighted)
- HTMX partial updates when switching tabs (Alpine x-show/x-cloak)
- All 324 tests pass
- Code has type hints

**Learnings for future iterations:**
- Tab buttons use :class binding to show active border/color
- Schema tab has x-data="{ searchQuery: '' }" for filtering
- Search uses .includes() to match column name or type (case insensitive)
- Partition columns marked with purple badge
- Column types shown in blue badges
- Nullable columns show "Yes" in gray, "No" in red
- Timestamps formatted with Alpine x-text="new Date(...).toLocaleString()"
- Snapshots reversed to show newest first

---
## 2026-01-16 - US-017
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Verified all acceptance criteria for US-017 (SQL Query Editor) are met
- Monaco editor with SQL syntax highlighting (loaded from cdnjs)
- Run button executes query via Alpine @click="executeQuery()"
- Timeout selector (dropdown: 30s, 60s, 5m, 15m, 1h) - x-model="timeout"
- Cancel button visible during execution (x-show="isExecuting")
- Error messages displayed clearly (x-show="error" with dismiss button)
- All 324 tests pass
- Code has type hints

**Learnings for future iterations:**
- Monaco editor requires CDN loader script and require.config()
- Editor value synced with Alpine sql variable via onDidChangeModelContent
- Keyboard shortcut: Ctrl/Cmd+Enter to execute query (via addCommand)
- Run button shows "Running..." spinner when isExecuting
- Cancel button posts to /api/v1/query/${queryId}/cancel
- Status polls /api/v1/query/${queryId}/status every 500ms
- Status states: pending, running, completed, failed, cancelled
- Error display has red background with dismiss button

---
## 2026-01-16 - US-018
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Verified all acceptance criteria for US-018 (Query Results Table) are met
- Results displayed in scrollable table with sticky headers
- Column headers clickable for sorting (Alpine @click="toggleSort(colIndex)")
- Per-column filter inputs (text and numeric range like ">100", "<=20")
- Pagination controls (page size selector, prev/next, current/total pages)
- Row count and execution time displayed
- Streaming indicator during data fetch (x-show="isStreaming")
- All 324 tests pass
- Code has type hints

**Learnings for future iterations:**
- Results table uses Alpine reactive data: columns, allRows, filteredRows, paginatedRows
- Sort state: sortColumn, sortDirection (third click removes sort)
- Filter inputs use x-model="columnFilters[colIndex]" with @input to apply
- Numeric range filters support: >, <, >=, <= operators
- Pagination: pageSize (100/250/500/1000), currentPage, totalPages computed
- Fetches from /api/v1/query/${queryId}/results?page_size=1000
- Parses JSON lines: metadata, data, progress, complete
- Sticky headers: position: sticky, z-index: 10 for th, z-index: 9 for filter row

---
## 2026-01-16 - US-019
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Verified all acceptance criteria for US-019 (CSV Export Button) are met
- Export button in results toolbar (x-show="columns.length > 0 && queryId")
- Shows progress for large exports (isExporting state with spinner)
- Downloads file with appropriate name (from Content-Disposition header)
- Disabled when no results available (disabled when isExecuting || !queryId)
- All 324 tests pass
- Code has type hints

**Learnings for future iterations:**
- Export button posts to /api/v1/export/csv with query_id
- Shows "Exporting..." spinner when isExporting
- Creates Blob from response.blob() and triggers download via anchor tag
- Extracts filename from Content-Disposition header with regex
- Uses window.URL.createObjectURL/revokeObjectURL for cleanup
- Downloads in browser, not streaming to disk directly
---
---
---
