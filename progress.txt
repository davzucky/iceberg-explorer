## Codebase Patterns
- Use `uv` for dependency management (uv sync, uv run pytest, uv run ruff check)
- Source code lives in `src/iceberg_explorer/` with packages: api/routes/, query/, models/, templates/
- Pre-commit hooks configured: ruff (lint/format), pyupgrade (Python 3.11+)
- Tests in `tests/` directory, run with `uv run pytest`
- Configuration uses pydantic-settings with env var prefix `ICEBERG_EXPLORER_` and `__` delimiter for nesting
- Use `get_settings()` for cached settings, `reset_settings()` in tests to clear cache
- Use `get_engine()` for cached DuckDB engine, `reset_engine()` in tests to clear cache
- Use `get_executor()` for cached QueryExecutor, `reset_executor()` in tests to clear cache
- DuckDB returns settings as native types (int for threads, MiB/GiB strings for memory) - don't assume string format
- Use `validate_sql()` to check SQL before execution; blocks INSERT, UPDATE, DELETE, DROP, CREATE, ALTER, etc.

---

## 2026-01-11 - US-001
Thread: https://ampcode.com/threads/T-019bab01-14f3-7755-b280-3c8fbe2d067d
- What was implemented:
  - Created pyproject.toml with FastAPI, DuckDB, Granian, OpenTelemetry dependencies
  - Set up src/iceberg_explorer/ package structure with api/routes, query, models, templates subdirs
  - Configured pre-commit hooks with ruff and pyupgrade
  - Created README.md with development instructions
  - Created basic test to verify version
- Files changed:
  - pyproject.toml (new)
  - .pre-commit-config.yaml (new)
  - README.md (new)
  - src/iceberg_explorer/__init__.py (new)
  - src/iceberg_explorer/main.py (new)
  - src/iceberg_explorer/api/__init__.py (new)
  - src/iceberg_explorer/api/routes/__init__.py (new)
  - src/iceberg_explorer/query/__init__.py (new)
  - src/iceberg_explorer/models/__init__.py (new)
  - tests/__init__.py (new)
  - tests/test_main.py (new)
- **Learnings for future iterations:**
  - hatchling build backend requires README.md to exist if referenced in pyproject.toml
  - Use `uv sync --all-extras` to install dev dependencies
  - pytest-asyncio requires `asyncio_default_fixture_loop_scope` setting in pyproject.toml for Python 3.14
---

## 2026-01-11 - US-002
Thread: https://ampcode.com/threads/T-019bab03-7ff1-732f-beaa-357a8a32c653
- What was implemented:
  - Created config.py with Pydantic models for configuration
  - Support for JSON file loading via ICEBERG_EXPLORER_CONFIG env var
  - Environment variable overrides with ICEBERG_EXPLORER_ prefix and __ delimiter
  - Catalog config (REST/local), Query config (timeouts, max_rows), DuckDB config (memory/threads)
  - Server config, OpenTelemetry config
  - Comprehensive test coverage (21 tests)
- Files changed:
  - src/iceberg_explorer/config.py (new)
  - tests/test_config.py (new)
- **Learnings for future iterations:**
  - pydantic-settings handles env var prefix and nested delimiter automatically
  - Use model_validator(mode="before") to load from JSON before other validation
  - Always use autouse fixture to reset_settings() in config tests to prevent state leakage
---

## 2026-01-11 - US-003
Thread: https://ampcode.com/threads/T-019bab05-bab4-732b-8d16-26b8c8ea9e36
- What was implemented:
  - Created DuckDBEngine class in query/engine.py
  - Connection manager with thread-safe initialization
  - Iceberg catalog attachment (REST and local catalog types)
  - Configurable memory limit and thread count from DuckDBConfig
  - Health check method verifying DuckDB and catalog connectivity
  - Global engine singleton with get_engine() and reset_engine()
  - Comprehensive test coverage (19 tests)
- Files changed:
  - src/iceberg_explorer/query/engine.py (new)
  - tests/test_engine.py (new)
- **Learnings for future iterations:**
  - DuckDB returns settings as native types (int for threads) not strings
  - DuckDB converts memory units (e.g., 1GB becomes ~953.6 MiB)
  - Use mock patching for _attach_catalog when testing engine init without real catalog
  - Combine pytest.raises with context manager using `with ..., ...` syntax (ruff SIM117)
---

## 2026-01-11 - US-004
Thread: https://ampcode.com/threads/T-019bab08-d892-72cf-b151-1945e8347cff
- What was implemented:
  - Created QueryExecutor class in query/executor.py
  - SQL validation to reject write operations (INSERT, UPDATE, DELETE, DROP, CREATE, ALTER, etc.)
  - Query execution with configurable timeout (10s - 3600s)
  - Results returned as Arrow batches for streaming
  - Execution metrics tracking (duration, rows returned)
  - Query cancellation via threading.Event interrupt
  - Query state management (pending, running, completed, failed, cancelled)
  - Global executor singleton with get_executor() and reset_executor()
  - Created query/models.py with QueryResult, ExecutionMetrics, QueryState, custom exceptions
  - Comprehensive test coverage (48 new tests, 87 total)
  - Added pyarrow dependency
- Files changed:
  - src/iceberg_explorer/query/executor.py (new)
  - src/iceberg_explorer/query/models.py (new)
  - tests/test_executor.py (new)
  - pyproject.toml (updated - added pyarrow)
- **Learnings for future iterations:**
  - DuckDB fetch_arrow_table() returns a PyArrow Table that can be converted to batches
  - Use threading.Event for cancellation signaling between threads
  - Ruff SIM114 prefers combining multiple if-elif with same body into tuple check
  - Always reset_executor() in test fixtures alongside reset_engine() and reset_settings()
---
