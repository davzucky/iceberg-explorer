## Codebase Patterns
- Use `uv` for dependency management (uv sync, uv run pytest, uv run ruff check)
- Source code lives in `src/iceberg_explorer/` with packages: api/routes/, query/, models/, templates/
- Pre-commit hooks configured: ruff (lint/format), pyupgrade (Python 3.11+)
- Tests in `tests/` directory, run with `uv run pytest`
- Configuration uses pydantic-settings with env var prefix `ICEBERG_EXPLORER_` and `__` delimiter for nesting
- Use `get_settings()` for cached settings, `reset_settings()` in tests to clear cache
- Use `get_engine()` for cached DuckDB engine, `reset_engine()` in tests to clear cache
- Use `get_executor()` for cached QueryExecutor, `reset_executor()` in tests to clear cache
- DuckDB returns settings as native types (int for threads, MiB/GiB strings for memory) - don't assume string format
- Use `validate_sql()` to check SQL before execution; blocks INSERT, UPDATE, DELETE, DROP, CREATE, ALTER, etc.
- API routes in `api/routes/*.py`, register routers in `main.py` with `app.include_router()`
- Multi-level namespace paths use unit separator (\x1f / %1F) as delimiter in API
- FastAPI routes with :path parameter: declare more specific routes (e.g., /tables/{path}/schema) before general ones (e.g., /tables/{path})
- API models in `models/` package (Pydantic), internal models in `query/models.py` (dataclasses)
- Query API: POST /api/v1/query/execute to execute, returns query_id for tracking

---

## 2026-01-11 - US-001
Thread: https://ampcode.com/threads/T-019bab01-14f3-7755-b280-3c8fbe2d067d
- What was implemented:
  - Created pyproject.toml with FastAPI, DuckDB, Granian, OpenTelemetry dependencies
  - Set up src/iceberg_explorer/ package structure with api/routes, query, models, templates subdirs
  - Configured pre-commit hooks with ruff and pyupgrade
  - Created README.md with development instructions
  - Created basic test to verify version
- Files changed:
  - pyproject.toml (new)
  - .pre-commit-config.yaml (new)
  - README.md (new)
  - src/iceberg_explorer/__init__.py (new)
  - src/iceberg_explorer/main.py (new)
  - src/iceberg_explorer/api/__init__.py (new)
  - src/iceberg_explorer/api/routes/__init__.py (new)
  - src/iceberg_explorer/query/__init__.py (new)
  - src/iceberg_explorer/models/__init__.py (new)
  - tests/__init__.py (new)
  - tests/test_main.py (new)
- **Learnings for future iterations:**
  - hatchling build backend requires README.md to exist if referenced in pyproject.toml
  - Use `uv sync --all-extras` to install dev dependencies
  - pytest-asyncio requires `asyncio_default_fixture_loop_scope` setting in pyproject.toml for Python 3.14
---

## 2026-01-11 - US-002
Thread: https://ampcode.com/threads/T-019bab03-7ff1-732f-beaa-357a8a32c653
- What was implemented:
  - Created config.py with Pydantic models for configuration
  - Support for JSON file loading via ICEBERG_EXPLORER_CONFIG env var
  - Environment variable overrides with ICEBERG_EXPLORER_ prefix and __ delimiter
  - Catalog config (REST/local), Query config (timeouts, max_rows), DuckDB config (memory/threads)
  - Server config, OpenTelemetry config
  - Comprehensive test coverage (21 tests)
- Files changed:
  - src/iceberg_explorer/config.py (new)
  - tests/test_config.py (new)
- **Learnings for future iterations:**
  - pydantic-settings handles env var prefix and nested delimiter automatically
  - Use model_validator(mode="before") to load from JSON before other validation
  - Always use autouse fixture to reset_settings() in config tests to prevent state leakage
---

## 2026-01-11 - US-003
Thread: https://ampcode.com/threads/T-019bab05-bab4-732b-8d16-26b8c8ea9e36
- What was implemented:
  - Created DuckDBEngine class in query/engine.py
  - Connection manager with thread-safe initialization
  - Iceberg catalog attachment (REST and local catalog types)
  - Configurable memory limit and thread count from DuckDBConfig
  - Health check method verifying DuckDB and catalog connectivity
  - Global engine singleton with get_engine() and reset_engine()
  - Comprehensive test coverage (19 tests)
- Files changed:
  - src/iceberg_explorer/query/engine.py (new)
  - tests/test_engine.py (new)
- **Learnings for future iterations:**
  - DuckDB returns settings as native types (int for threads) not strings
  - DuckDB converts memory units (e.g., 1GB becomes ~953.6 MiB)
  - Use mock patching for _attach_catalog when testing engine init without real catalog
  - Combine pytest.raises with context manager using `with ..., ...` syntax (ruff SIM117)
---

## 2026-01-11 - US-004
Thread: https://ampcode.com/threads/T-019bab08-d892-72cf-b151-1945e8347cff
- What was implemented:
  - Created QueryExecutor class in query/executor.py
  - SQL validation to reject write operations (INSERT, UPDATE, DELETE, DROP, CREATE, ALTER, etc.)
  - Query execution with configurable timeout (10s - 3600s)
  - Results returned as Arrow batches for streaming
  - Execution metrics tracking (duration, rows returned)
  - Query cancellation via threading.Event interrupt
  - Query state management (pending, running, completed, failed, cancelled)
  - Global executor singleton with get_executor() and reset_executor()
  - Created query/models.py with QueryResult, ExecutionMetrics, QueryState, custom exceptions
  - Comprehensive test coverage (48 new tests, 87 total)
  - Added pyarrow dependency
- Files changed:
  - src/iceberg_explorer/query/executor.py (new)
  - src/iceberg_explorer/query/models.py (new)
  - tests/test_executor.py (new)
  - pyproject.toml (updated - added pyarrow)
- **Learnings for future iterations:**
  - DuckDB fetch_arrow_table() returns a PyArrow Table that can be converted to batches
  - Use threading.Event for cancellation signaling between threads
  - Ruff SIM114 prefers combining multiple if-elif with same body into tuple check
  - Always reset_executor() in test fixtures alongside reset_engine() and reset_settings()
---

## 2026-01-11 - US-005
Thread: https://ampcode.com/threads/T-019bab0c-f772-77ad-9809-f355ad3b1087
- What was implemented:
  - Created Pydantic models for catalog browsing in models/catalog.py
  - NamespaceIdentifier, ListNamespacesResponse, TableIdentifier, ListTablesResponse
  - GET /api/v1/catalog/namespaces endpoint for listing namespaces
  - Support for parent namespace parameter with unit separator (\x1f / %1F) for multi-level
  - 404 handling for non-existent parent namespaces
  - page-token and page-size query parameters (pagination not yet implemented)
  - Registered catalog router in main.py
  - Comprehensive test coverage (19 new tests, 106 total)
- Files changed:
  - src/iceberg_explorer/models/catalog.py (new)
  - src/iceberg_explorer/models/__init__.py (updated - exports)
  - src/iceberg_explorer/api/routes/catalog.py (new)
  - src/iceberg_explorer/main.py (updated - router registration)
  - tests/test_catalog.py (new)
- **Learnings for future iterations:**
  - Unit separator character (\x1f) must be URL-encoded as %1F in HTTP requests
  - Use `raise ... from e` for exception chaining (ruff B904)
  - Use `# noqa: ARG001` for intentionally unused function arguments (pagination params for future)
  - Filter out internal DuckDB schemas (main, information_schema, pg_catalog) from namespace listings
---

## 2026-01-11 - US-006
Thread: https://ampcode.com/threads/T-019bab11-c03d-773f-b10d-817ffe80ca82
- What was implemented:
  - GET /api/v1/catalog/namespaces/{namespace}/tables endpoint for listing tables
  - Support for unit separator (\x1f / %1F) for multi-level namespace paths
  - 404 error handling for non-existent namespaces
  - Query information_schema.tables to retrieve table list
  - Returns table identifiers with namespace array and table name
  - 9 new tests (28 catalog tests total, 115 overall)
- Files changed:
  - src/iceberg_explorer/api/routes/catalog.py (updated - added list_tables endpoint)
  - tests/test_catalog.py (updated - added TestListTablesEndpoint and TestTableIdentifierModel)
- **Learnings for future iterations:**
  - Query table_schema column to filter tables for correct namespace level
  - Reuse existing helper functions (_parse_namespace, _build_namespace_path, _quote_identifier)
  - Existing patterns from US-005 namespaces endpoint apply directly to tables endpoint
---

## 2026-01-11 - US-007
Thread: https://ampcode.com/threads/T-019bab13-e9d7-74e3-acc3-93c198a8ed13
- What was implemented:
  - Created Pydantic models for table details: TableDetails, Snapshot, PartitionSpec, PartitionField, SortOrder, SortField
  - GET /api/v1/catalog/tables/{namespace}.{table} endpoint for viewing table metadata
  - Endpoint returns: namespace, name, location, format, partition_spec, sort_order, current_snapshot, snapshots
  - Uses iceberg_snapshots() DuckDB function to retrieve snapshot history
  - Uses iceberg_metadata() to extract table location from manifest paths
  - 404 error handling for non-existent tables
  - 400 error handling for invalid path format
  - 29 new tests (49 catalog tests total, 135 overall)
- Files changed:
  - src/iceberg_explorer/models/catalog.py (updated - added TableDetails, Snapshot, PartitionSpec, SortOrder models)
  - src/iceberg_explorer/models/__init__.py (updated - exports for new models)
  - src/iceberg_explorer/api/routes/catalog.py (updated - added get_table_details endpoint and _parse_table_path helper)
  - tests/test_catalog.py (updated - added TestTableDetailsModels, TestTableDetailsEndpoint, TestParseTablePath)
- **Learnings for future iterations:**
  - DuckDB iceberg_snapshots() returns timestamp_ms as various types (datetime, string, int) - handle all cases
  - Use path:path in FastAPI route to capture full path including dots
  - iceberg_metadata() returns manifest_path which can be parsed to extract table location
  - Table path format uses dot separator between namespace and table name, with unit separator for multi-level namespaces
---

## 2026-01-11 - US-008
Thread: https://ampcode.com/threads/T-019bab18-1cb1-70e8-84df-c8ca2b2964ce
- What was implemented:
  - Created Pydantic models for table schema: SchemaField, ColumnStatistics, TableSchemaResponse
  - GET /api/v1/catalog/tables/{namespace}.{table}/schema endpoint for viewing table schema
  - Returns: namespace, name, schema_id, fields with column name, type, field_id, nullable flag
  - Marks partition columns with is_partition_column indicator
  - Supports column statistics (null_count, min_value, max_value) if available
  - Query information_schema.columns for column metadata
  - Uses iceberg_metadata() to detect partition columns from partition_value
  - 15 new tests (63 catalog tests total, 150 overall)
- Files changed:
  - src/iceberg_explorer/models/catalog.py (updated - added SchemaField, ColumnStatistics, TableSchemaResponse)
  - src/iceberg_explorer/models/__init__.py (updated - exports for new models)
  - src/iceberg_explorer/api/routes/catalog.py (updated - added get_table_schema endpoint)
  - tests/test_catalog.py (updated - added TestSchemaModels, TestTableSchemaEndpoint)
- **Learnings for future iterations:**
  - FastAPI routes with :path parameter must have more specific routes declared first (schema endpoint before table details)
  - Query information_schema.columns for column_name, data_type, ordinal_position, is_nullable
  - Parse partition columns from iceberg_metadata() partition_value field (format: "col=value, col2=value2")
  - is_nullable values from information_schema can be "YES", "NO", or None (default to True for None)
---

## 2026-01-11 - US-009
Thread: https://ampcode.com/threads/T-019bab1d-6802-73fd-b738-5db375649ca6
- What was implemented:
  - Created Pydantic models for query API in models/query.py
  - ExecuteQueryRequest, ExecuteQueryResponse, QueryErrorResponse
  - POST /api/v1/query/execute endpoint for executing SQL queries
  - SQL validation using existing validate_sql() before execution
  - Returns query_id for tracking and current status
  - Timeout parameter validation (10s-3600s) with Pydantic constraints
  - 400 response for invalid SQL (write operations rejected)
  - 500 response for executor errors
  - Registered query router in main.py
  - 38 new tests (188 total)
- Files changed:
  - src/iceberg_explorer/models/query.py (new)
  - src/iceberg_explorer/models/__init__.py (updated - exports)
  - src/iceberg_explorer/api/routes/query.py (new)
  - src/iceberg_explorer/main.py (updated - router registration)
  - tests/test_query_api.py (new)
- **Learnings for future iterations:**
  - Reuse validate_sql() from query/executor.py for API-level validation
  - API models in models/query.py vs internal models in query/models.py separation
  - Use Pydantic Field constraints (ge, le) for timeout range validation at API boundary
  - Mock get_executor() and return MagicMock(spec=QueryResult) for API tests
---

## 2026-01-11 - US-011
Thread: https://ampcode.com/threads/T-019bab35-8212-73d9-82f1-718c11808f99
- What was implemented:
  - Created QueryStatusResponse Pydantic model with query_id, status, rows_processed, error_message fields
  - GET /api/v1/query/{query_id}/status endpoint for checking query status
  - Returns current state (pending, running, completed, failed, cancelled)
  - Returns rows_processed for running/completed queries
  - Returns error_message for failed queries
  - 404 for non-existent queries, 400 for invalid query ID format
  - 10 new tests (71 query API tests total, 221 overall)
- Files changed:
  - src/iceberg_explorer/models/query.py (updated - added QueryStatusResponse)
  - src/iceberg_explorer/models/__init__.py (updated - exports)
  - src/iceberg_explorer/api/routes/query.py (updated - added get_query_status endpoint)
  - tests/test_query_api.py (updated - added TestQueryStatusEndpoint)
- **Learnings for future iterations:**
  - Reuse executor.get_status() which returns QueryResult with state and metrics
  - QueryState enum values match expected API status strings (pending, running, etc.)
  - Follow existing pattern: 400 for invalid input format, 404 for not found
---

## 2026-01-11 - US-012
Thread: https://ampcode.com/threads/T-019bab38-4b01-775c-9ef2-d8393f1a4abb
- What was implemented:
  - Created CancelQueryResponse Pydantic model with query_id, cancelled, status fields
  - POST /api/v1/query/{query_id}/cancel endpoint for cancelling queries
  - Calls executor.cancel() to interrupt DuckDB query cleanly
  - Returns success (200) even if query already finished (completed, failed, cancelled)
  - Returns cancelled=true if query was actively cancelled, false if already terminal
  - 404 for non-existent queries, 400 for invalid query ID format
  - 11 new tests (81 query API tests total, 231 overall)
- Files changed:
  - src/iceberg_explorer/models/query.py (updated - added CancelQueryResponse)
  - src/iceberg_explorer/models/__init__.py (updated - exports)
  - src/iceberg_explorer/api/routes/query.py (updated - added cancel_query endpoint)
  - tests/test_query_api.py (updated - added TestCancelQueryEndpoint)
- **Learnings for future iterations:**
  - Reuse existing executor.cancel() method which already handles threading.Event cancellation
  - Follow existing pattern: 400 for invalid input format, 404 for not found
  - executor.cancel() returns False for terminal queries (completed/failed/cancelled)
  - Query status and cancel endpoint patterns are identical for error handling
---

## 2026-01-11 - US-020
Thread: https://ampcode.com/threads/T-019bab3b-5c4a-72f9-91e4-c22e62efa689
- What was implemented:
  - Created health routes with GET /health and GET /ready endpoints
  - /health returns status (healthy/degraded/unhealthy), version, and component health
  - /ready returns readiness status with reason if not ready
  - Checks DuckDB connectivity and catalog accessibility via engine.health_check()
  - Returns 503 status code when unhealthy
  - Pydantic models: ComponentHealth, HealthResponse, ReadyResponse
  - Registered health router in main.py
  - 18 new tests (249 total)
- Files changed:
  - src/iceberg_explorer/api/routes/health.py (new)
  - src/iceberg_explorer/main.py (updated - router registration)
  - tests/test_health.py (new)
- **Learnings for future iterations:**
  - Reuse engine.health_check() which returns dict with healthy, duckdb, catalog, error keys
  - FastAPI Response parameter allows setting status_code dynamically
  - Use 503 for unhealthy/not ready responses per HTTP conventions
---
